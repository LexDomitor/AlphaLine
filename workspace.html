document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;

    // 1. Calculate the intended movement based on the mouse delta
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;

    let newX = initialLeft + dx;
    let newY = initialTop + dy;

    // 2. Refresh dimensions EVERY frame to catch layout shifts
    const viewportW = window.innerWidth;
    const viewportH = window.innerHeight;
    
    // Dynamically get the exact line where the top bar ends
    const topBarEdge = header.getBoundingClientRect().bottom;
    
    // Get the exact visual footprint of the HUD (including buttons)
    const hudRect = hud.getBoundingClientRect();
    const hudW = hudRect.width;
    const hudH = hudRect.height;

    // 3. SOUND BOUNDARY LOGIC
    // Horizontal
    if (newX < 0) newX = 0;
    if (newX + hudW > viewportW) newX = viewportW - hudW;

    // Vertical: The "Snug" Constraint
    // If the top of the HUD is less than the header's bottom, force it to the bottom
    if (newY < topBarEdge) newY = topBarEdge;
    
    // Vertical: The "Floor" Constraint
    // If the top + height exceeds the viewport, force it to (Viewport - Height)
    if (newY + hudH > viewportH) newY = viewportH - hudH;

    // 4. Apply the strictly clamped coordinates
    hud.style.left = newX + 'px';
    hud.style.top = newY + 'px';
});
